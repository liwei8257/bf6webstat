<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BF6 ç©å®¶æ•°æ®ç»Ÿè®¡</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <div class="container">
        <header>
            <h1>ğŸ® Battlefield 6 ç©å®¶æ•°æ®ç»Ÿè®¡</h1>
            <p class="subtitle">å®æ—¶æŸ¥è¯¢å’Œå¯¹æ¯”ç©å®¶æˆ˜ç»©</p>
        </header>

        <div class="controls">
            <button id="refreshBtn" class="btn btn-primary">
                <span id="btnText">ğŸ”„ åˆ·æ–°æ•°æ®</span>
                <span id="btnLoading" class="loading" style="display: none;">
                    <span class="spinner"></span> åŠ è½½ä¸­...
                </span>
            </button>
            <div class="info">
                <span id="updateTime">-</span>
                <span id="playerCount">ç©å®¶æ•°: 0</span>
            </div>
        </div>

        <!-- è¿›åº¦æ¡ -->
        <div id="progressContainer" class="progress-container" style="display: none;">
            <div class="progress-header">
                <span id="progressText">æ­£åœ¨è·å–æ•°æ®...</span>
                <span id="progressPercent">0%</span>
            </div>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
            <div id="progressDetail" class="progress-detail"></div>
        </div>

        <div id="errorMessage" class="error-message" style="display: none;"></div>

        <div class="table-container">
            <table id="statsTable">
                <thead>
                    <tr>
                        <th data-sort="name">ç©å®¶åç§° <span class="sort-indicator"></span></th>
                        <th data-sort="platform">å¹³å° <span class="sort-indicator"></span></th>
                        <th data-sort="kills" class="sortable">å‡»æ€ <span class="sort-indicator"></span></th>
                        <th data-sort="deaths" class="sortable">æ­»äº¡ <span class="sort-indicator"></span></th>
                        <th data-sort="kd_ratio" class="sortable">K/D <span class="sort-indicator"></span></th>
                        <th data-sort="wins" class="sortable">èƒœåœº <span class="sort-indicator"></span></th>
                        <th data-sort="win_rate" class="sortable">èƒœç‡% <span class="sort-indicator"></span></th>
                        <th data-sort="score_per_minute" class="sortable">åˆ†é’Ÿå¾—åˆ† <span class="sort-indicator"></span></th>
                        <th data-sort="kills_per_minute" class="sortable">åˆ†é’Ÿå‡»æ€ <span class="sort-indicator"></span></th>
                        <th data-sort="accuracy" class="sortable">å‡†ç¡®ç‡% <span class="sort-indicator"></span></th>
                        <th data-sort="headshot_percentage" class="sortable">çˆ†å¤´ç‡% <span class="sort-indicator"></span>
                        </th>
                        <th data-sort="matches_played" class="sortable">æ¯”èµ›åœºæ•° <span class="sort-indicator"></span></th>
                        <th data-sort="time_played" class="sortable">æ¸¸æˆæ—¶é•¿(h) <span class="sort-indicator"></span></th>
                    </tr>
                </thead>
                <tbody id="statsBody">
                    <tr>
                        <td colspan="13" class="loading-cell">
                            <div class="loading-text">ç‚¹å‡»"åˆ·æ–°æ•°æ®"æŒ‰é’®åŠ è½½ç©å®¶ç»Ÿè®¡...</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <footer>
            <p>æ•°æ®æ¥æº: <a href="https://tracker.gg" target="_blank">tracker.gg</a></p>
            <p id="footerInfo">ç¼“å­˜æ—¶é—´: 60ç§’ | <span id="modeInfo"></span></p>
        </footer>

        <script>
            // åœ¨é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºæ¨¡å¼ä¿¡æ¯
            document.addEventListener('DOMContentLoaded', function () {
                const modeInfo = document.getElementById('modeInfo');
                if (isProduction()) {
                    modeInfo.textContent = 'ğŸ“Š ç”Ÿäº§æ¨¡å¼ï¼šé™æ€æ•°æ®';
                    modeInfo.style.color = '#10b981';
                } else {
                    modeInfo.textContent = 'ğŸ”„ å¼€å‘æ¨¡å¼ï¼šå®æ—¶æŸ¥è¯¢';
                    modeInfo.style.color = '#2563eb';
                }
            });
        </script>
    </div>

    <script>
        let playersData = [];
        let currentSort = { column: null, ascending: true };

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è·å–æ•°æ®
        window.addEventListener('DOMContentLoaded', () => {
            fetchPlayersData();
        });

        // åˆ·æ–°æŒ‰é’®äº‹ä»¶
        document.getElementById('refreshBtn').addEventListener('click', () => {
            fetchPlayersData();
        });

        // æ£€æµ‹æ˜¯å¦ä¸ºç”Ÿäº§ç¯å¢ƒï¼ˆRenderï¼‰æˆ–å¼ºåˆ¶é™æ€æ¨¡å¼
        function isProduction() {
            // æ£€æŸ¥URLå‚æ•°æ˜¯å¦å¼ºåˆ¶ä½¿ç”¨é™æ€æ¨¡å¼
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('static') === 'true') {
                return true;
            }
            // æ£€æŸ¥æ˜¯å¦ä¸ºRenderåŸŸå
            return window.location.hostname.includes('onrender.com') ||
                window.location.hostname.includes('render.com');
        }

        // è·å–ç©å®¶æ•°æ®
        async function fetchPlayersData() {
            const btn = document.getElementById('refreshBtn');
            const btnText = document.getElementById('btnText');
            const btnLoading = document.getElementById('btnLoading');
            const errorMsg = document.getElementById('errorMessage');
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressPercent = document.getElementById('progressPercent');
            const progressDetail = document.getElementById('progressDetail');

            btn.disabled = true;
            btnText.style.display = 'none';
            btnLoading.style.display = 'inline-flex';
            errorMsg.style.display = 'none';

            // æ˜¾ç¤ºè¿›åº¦æ¡
            progressContainer.style.display = 'block';
            progressFill.style.width = '0%';
            progressText.textContent = 'æ­£åœ¨è·å–æ•°æ®...';
            progressPercent.textContent = '0%';

            // æ ¹æ®ç¯å¢ƒé€‰æ‹©API
            const isStatic = isProduction();
            const apiUrl = isStatic ? '/api/players/static' : '/api/players';
            progressDetail.textContent = isStatic ?
                'ä»é™æ€å¿«ç…§è¯»å–æ•°æ®...' :
                'å®æ—¶æŸ¥è¯¢ä¸­...';

            try {
                // æ¨¡æ‹Ÿè¿›åº¦ï¼ˆå› ä¸ºåç«¯è¿”å›æ˜¯ä¸€æ¬¡æ€§çš„ï¼‰
                let fakeProgress = 0;
                const progressInterval = setInterval(() => {
                    if (fakeProgress < 90) {
                        fakeProgress += Math.random() * 10;
                        if (fakeProgress > 90) fakeProgress = 90;
                        progressFill.style.width = fakeProgress + '%';
                        progressPercent.textContent = Math.round(fakeProgress) + '%';
                    }
                }, isStatic ? 100 : 500); // é™æ€æ•°æ®åŠ è½½æ›´å¿«

                const response = await fetch(apiUrl);
                const result = await response.json();

                clearInterval(progressInterval);

                if (result.success) {
                    // å®Œæˆè¿›åº¦
                    progressFill.style.width = '100%';
                    progressPercent.textContent = '100%';

                    let detailText = `æˆåŠŸè·å– ${result.data.length} åç©å®¶æ•°æ®`;
                    if (result.update_time) {
                        detailText += ` (æ•°æ®æ›´æ–°æ—¶é—´: ${result.update_time})`;
                    }
                    progressDetail.textContent = detailText;

                    playersData = result.data;
                    renderTable(playersData);
                    updateInfo(result.update_time);

                    // 2ç§’åéšè—è¿›åº¦æ¡
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                    }, 2000);
                } else {
                    clearInterval(progressInterval);
                    progressContainer.style.display = 'none';
                    showError('è·å–æ•°æ®å¤±è´¥: ' + result.error);
                }
            } catch (error) {
                progressContainer.style.display = 'none';
                showError('ç½‘ç»œé”™è¯¯: ' + error.message);
            } finally {
                btn.disabled = false;
                btnText.style.display = 'inline';
                btnLoading.style.display = 'none';
            }
        }

        // æ¸²æŸ“è¡¨æ ¼
        function renderTable(data) {
            const tbody = document.getElementById('statsBody');

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="13" class="loading-cell">æš‚æ— æ•°æ®</td></tr>';
                return;
            }

            tbody.innerHTML = data.map((player, index) => {
                if (player.error) {
                    return `
                        <tr class="error-row">
                            <td>${escapeHtml(player.name)}</td>
                            <td>${escapeHtml(player.platform)}</td>
                            <td colspan="11" class="error-cell">âŒ ${escapeHtml(player.error)}</td>
                        </tr>
                    `;
                }

                const timePlayedHours = (player.time_played / 3600).toFixed(1);

                return `
                    <tr>
                        <td class="player-name">${escapeHtml(player.name)}</td>
                        <td>${escapeHtml(player.platform)}</td>
                        <td>${formatNumber(player.kills)}</td>
                        <td>${formatNumber(player.deaths)}</td>
                        <td class="highlight">${formatDecimal(player.kd_ratio, 2)}</td>
                        <td>${formatNumber(player.wins)}</td>
                        <td class="highlight">${formatDecimal(player.win_rate, 1)}%</td>
                        <td>${formatDecimal(player.score_per_minute, 0)}</td>
                        <td>${formatDecimal(player.kills_per_minute, 2)}</td>
                        <td>${formatDecimal(player.accuracy, 1)}%</td>
                        <td>${formatDecimal(player.headshot_percentage, 1)}%</td>
                        <td>${formatNumber(player.matches_played)}</td>
                        <td>${timePlayedHours}</td>
                    </tr>
                `;
            }).join('');
        }

        // æ’åºåŠŸèƒ½
        document.querySelectorAll('th[data-sort]').forEach(th => {
            th.addEventListener('click', () => {
                const column = th.dataset.sort;
                sortTable(column);
            });
        });

        function sortTable(column) {
            // å¦‚æœç‚¹å‡»ç›¸åŒåˆ—ï¼Œåˆ™åˆ‡æ¢æ’åºæ–¹å‘
            if (currentSort.column === column) {
                currentSort.ascending = !currentSort.ascending;
            } else {
                currentSort.column = column;
                currentSort.ascending = false; // é»˜è®¤é™åºï¼ˆå¤§åˆ°å°ï¼‰
            }

            // æ›´æ–°æ’åºæŒ‡ç¤ºå™¨
            document.querySelectorAll('.sort-indicator').forEach(el => {
                el.textContent = '';
            });
            const indicator = document.querySelector(`th[data-sort="${column}"] .sort-indicator`);
            indicator.textContent = currentSort.ascending ? ' â–²' : ' â–¼';

            // æ’åºæ•°æ®
            const sorted = [...playersData].sort((a, b) => {
                // å¤„ç†é”™è¯¯è¡Œ
                if (a.error && !b.error) return 1;
                if (!a.error && b.error) return -1;
                if (a.error && b.error) return 0;

                let valA = a[column];
                let valB = b[column];

                // å­—ç¬¦ä¸²æ’åº
                if (typeof valA === 'string') {
                    return currentSort.ascending
                        ? valA.localeCompare(valB)
                        : valB.localeCompare(valA);
                }

                // æ•°å€¼æ’åº
                valA = parseFloat(valA) || 0;
                valB = parseFloat(valB) || 0;

                return currentSort.ascending ? valA - valB : valB - valA;
            });

            renderTable(sorted);
        }

        // æ›´æ–°ä¿¡æ¯
        function updateInfo(dataUpdateTime) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN');

            let updateText = `æŸ¥è¯¢æ—¶é—´: ${timeStr}`;
            if (dataUpdateTime) {
                updateText += ` (æ•°æ®: ${dataUpdateTime})`;
            }

            document.getElementById('updateTime').textContent = updateText;
            document.getElementById('playerCount').textContent = `ç©å®¶æ•°: ${playersData.length}`;

            // æ˜¾ç¤ºç¯å¢ƒæç¤º
            if (isProduction()) {
                document.getElementById('updateTime').title = 'ç”Ÿäº§ç¯å¢ƒï¼šæ˜¾ç¤ºé™æ€å¿«ç…§æ•°æ®';
            } else {
                document.getElementById('updateTime').title = 'æœ¬åœ°ç¯å¢ƒï¼šå®æ—¶æŸ¥è¯¢æ•°æ®';
            }
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            const errorMsg = document.getElementById('errorMessage');
            errorMsg.textContent = message;
            errorMsg.style.display = 'block';
        }

        // å·¥å…·å‡½æ•°
        function formatNumber(num) {
            return num ? num.toLocaleString('zh-CN') : '0';
        }

        function formatDecimal(num, decimals) {
            return num ? parseFloat(num).toFixed(decimals) : '0';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>

</html>