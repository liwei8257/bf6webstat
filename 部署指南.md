# 🚀 BF6玩家数据统计系统 - 部署指南

## 📋 目录
- [服务器部署方案](#服务器部署方案)
- [Linux部署详细步骤](#linux部署详细步骤)
- [Docker部署](#docker部署)
- [Windows服务器部署](#windows服务器部署)
- [安全建议](#安全建议)

---

## 🌐 服务器部署方案

### 方案对比

| 方案 | 优点 | 适用场景 |
|------|------|----------|
| **Gunicorn + Nginx** | 性能好、稳定 | Linux服务器（推荐）|
| **Docker** | 易部署、隔离好 | 任何支持Docker的环境 |
| **云平台PaaS** | 免运维、自动扩展 | Railway/Render/Heroku |
| **Windows IIS** | Windows原生支持 | Windows Server |

---

## 🐧 Linux部署详细步骤

### 1. 准备服务器

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装Python 3.8+
sudo apt install python3 python3-pip python3-venv -y

# 安装Nginx
sudo apt install nginx -y
```

### 2. 上传项目文件

```bash
# 创建项目目录
sudo mkdir -p /var/www/bf6stat
cd /var/www/bf6stat

# 上传所有项目文件
# 可以使用 scp, rsync 或 git clone
git clone <your-repo-url> .
# 或者
scp -r ./* user@server:/var/www/bf6stat/
```

### 3. 配置Python环境

```bash
# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 设置环境变量
export FLASK_ENV=production
export SECRET_KEY=$(python3 -c "import secrets; print(secrets.token_hex(32))")
```

### 4. 创建systemd服务

创建文件 `/etc/systemd/system/bf6stat.service`:

```ini
[Unit]
Description=BF6 Stats Web Application
After=network.target

[Service]
Type=notify
User=www-data
Group=www-data
WorkingDirectory=/var/www/bf6stat
Environment="FLASK_ENV=production"
Environment="SECRET_KEY=your-secret-key-here"
ExecStart=/var/www/bf6stat/venv/bin/gunicorn \
    --workers 4 \
    --bind 127.0.0.1:8000 \
    --timeout 120 \
    --access-logfile /var/log/bf6stat/access.log \
    --error-logfile /var/log/bf6stat/error.log \
    wsgi:app

Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

```bash
# 创建日志目录
sudo mkdir -p /var/log/bf6stat
sudo chown www-data:www-data /var/log/bf6stat

# 设置权限
sudo chown -R www-data:www-data /var/www/bf6stat

# 启动服务
sudo systemctl daemon-reload
sudo systemctl start bf6stat
sudo systemctl enable bf6stat

# 查看状态
sudo systemctl status bf6stat
```

### 5. 配置Nginx反向代理

创建文件 `/etc/nginx/sites-available/bf6stat`:

```nginx
server {
    listen 80;
    server_name your-domain.com;  # 改成你的域名

    # 静态文件
    location /static {
        alias /var/www/bf6stat/static;
        expires 30d;
    }

    # 代理到Gunicorn
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 120s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
    }
}
```

```bash
# 启用站点
sudo ln -s /etc/nginx/sites-available/bf6stat /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx
```

### 6. 配置SSL（HTTPS）- 可选但推荐

```bash
# 安装Certbot
sudo apt install certbot python3-certbot-nginx -y

# 获取SSL证书
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo certbot renew --dry-run
```

---

## 🐳 Docker部署

### 1. 创建Dockerfile

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# 安装依赖
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 复制项目文件
COPY . .

# 暴露端口
EXPOSE 5000

# 设置环境变量
ENV FLASK_ENV=production

# 启动命令
CMD ["gunicorn", "--bind", "0.0.0.0:5000", "--workers", "4", "--timeout", "120", "wsgi:app"]
```

### 2. 创建docker-compose.yml

```yaml
version: '3.8'

services:
  web:
    build: .
    ports:
      - "8000:5000"
    environment:
      - FLASK_ENV=production
      - SECRET_KEY=${SECRET_KEY}
      - TRN_API_KEY=${TRN_API_KEY}
    volumes:
      - ./players.json:/app/players.json
    restart: unless-stopped
```

### 3. 部署

```bash
# 构建镜像
docker-compose build

# 启动服务
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down
```

---

## 💻 Windows服务器部署

### 使用waitress（推荐）

```bash
# 安装waitress
pip install waitress

# 创建启动脚本 run_production.py
```

创建 `run_production.py`:

```python
from waitress import serve
from app import app
import os

os.environ['FLASK_ENV'] = 'production'

if __name__ == '__main__':
    print("🚀 BF6玩家数据统计系统启动中...")
    print("📊 访问: http://0.0.0.0:8080")
    serve(app, host='0.0.0.0', port=8080, threads=4)
```

```bash
# 运行
python run_production.py
```

### 使用NSSM创建Windows服务

```bash
# 下载NSSM: https://nssm.cc/download
# 安装服务
nssm install BF6Stats "C:\Python311\python.exe" "C:\bf6stat\run_production.py"

# 启动服务
nssm start BF6Stats
```

---

## ☁️ 云平台部署（最简单）

### Railway部署

1. 访问 [railway.app](https://railway.app)
2. 连接GitHub仓库
3. 添加环境变量：`FLASK_ENV=production`
4. 自动部署完成

### Render部署

1. 访问 [render.com](https://render.com)
2. 创建Web Service
3. 连接Git仓库
4. 设置启动命令：`gunicorn wsgi:app`
5. 自动部署

---

## 🔒 安全建议

### 1. 环境变量配置

创建 `.env` 文件（不要提交到Git）：

```bash
FLASK_ENV=production
SECRET_KEY=your-random-secret-key-here
TRN_API_KEY=your-tracker-api-key
```

### 2. 防火墙配置

```bash
# Ubuntu/Debian
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable
```

### 3. 限制访问（可选）

在Nginx配置中添加：

```nginx
# IP白名单
allow 1.2.3.4;
deny all;

# 或基本认证
auth_basic "Restricted Access";
auth_basic_user_file /etc/nginx/.htpasswd;
```

### 4. 定期更新

```bash
# 自动更新脚本
cd /var/www/bf6stat
git pull
source venv/bin/activate
pip install -r requirements.txt
sudo systemctl restart bf6stat
```

---

## 🔧 性能优化

### 1. Gunicorn工作进程数

```bash
# 推荐：(2 × CPU核心数) + 1
# 4核CPU: --workers 9
```

### 2. Nginx缓存

```nginx
# 添加到nginx配置
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=bf6cache:10m max_size=100m;
proxy_cache bf6cache;
proxy_cache_valid 200 30s;
```

### 3. Redis缓存（高级）

如果需要更好的缓存性能，可以集成Redis：

```bash
pip install redis flask-caching
```

---

## 📊 监控和日志

### 查看日志

```bash
# systemd服务日志
sudo journalctl -u bf6stat -f

# Nginx访问日志
sudo tail -f /var/log/nginx/access.log

# 应用日志
sudo tail -f /var/log/bf6stat/access.log
```

### 监控工具推荐

- **Uptime Kuma**: 免费开源监控
- **UptimeRobot**: 免费外网监控
- **Prometheus + Grafana**: 专业监控方案

---

## 🆘 常见问题

### 端口被占用
```bash
sudo lsof -i :8000
sudo kill -9 <PID>
```

### 权限问题
```bash
sudo chown -R www-data:www-data /var/www/bf6stat
sudo chmod -R 755 /var/www/bf6stat
```

### 重启服务
```bash
sudo systemctl restart bf6stat
sudo systemctl restart nginx
```

---

## 📞 需要帮助？

如果部署过程中遇到问题：
1. 检查日志文件
2. 确认防火墙设置
3. 验证环境变量
4. 测试网络连接

祝部署顺利！🎉

